{"version":3,"file":"createSubscriber.js","sources":["../src/subscriptions.js","../src/createSubscriber.js"],"sourcesContent":["// @flow\n\nimport type {Disposable} from \"react-relay\";\nimport type {Notifier} from \"@absinthe/socket\";\n\nconst subscriptions: WeakMap<\n  Disposable,\n  Promise<Notifier<any>>\n> = new WeakMap();\n\nexport default subscriptions;\n","// @flow\n\nimport notifierFind from \"@absinthe/socket/dist/notifier/find\";\nimport {observe, send, unobserveOrCancel} from \"@absinthe/socket\";\nimport {createDeferred} from \"@jumpn/utils-promise\";\nimport {getOperationType} from \"@jumpn/utils-graphql\";\n\nimport type {AbsintheSocket} from \"@absinthe/socket\";\nimport type {SubscribeFunction} from \"react-relay\";\n\nimport subscriptions from \"./subscriptions\";\n\nconst unobserveOrCancelIfNeeded = (absintheSocket, notifier, observer) => {\n  if (notifier) {\n    unobserveOrCancel(absintheSocket, notifier, observer);\n  }\n};\n\nconst createDisposable = (absintheSocket, {request}, observer) => ({\n  dispose: () =>\n    unobserveOrCancelIfNeeded(\n      absintheSocket,\n      notifierFind(absintheSocket.notifiers, \"request\", request),\n      observer\n    )\n});\n\nconst onStart = deferred => notifier => deferred.resolve(notifier);\n\nconst onAbort = (deferred, callback) => error => {\n  // callback is always defined but this is not correctly reflected in\n  // SubscribeFunction\n  callback && callback(error);\n\n  deferred.reject(error);\n};\n\n/**\n * Creates a Subscriber (Relay SubscribeFunction) using the given AbsintheSocket\n * instance\n */\nconst createSubscriber = (\n  absintheSocket: AbsintheSocket,\n  onRecoverableError?: (error: Error) => any\n): SubscribeFunction => (\n  {text: operation},\n  variables,\n  cacheConfig,\n  {onError: OnUnrecoverableError, onNext}\n) => {\n  // we need to place this logic here and not in ensureIsSubscription as if we\n  // do so, then flow is not able to infer we are validating operation\n  if (!operation || getOperationType(operation) !== \"subscription\") {\n    throw new Error(\n      `Expected subscription, but instead got:\\n${(operation: any)}`\n    );\n  }\n\n  const notifier = send(absintheSocket, {operation, variables});\n\n  const deferred = createDeferred();\n\n  const observer = {\n    onAbort: onAbort(deferred, OnUnrecoverableError),\n    onError: onRecoverableError,\n    onResult: (onNext: any),\n    onStart: onStart(deferred)\n  };\n\n  observe(absintheSocket, notifier, observer);\n\n  const disposable = createDisposable(absintheSocket, notifier, observer);\n\n  subscriptions.set(disposable, deferred.promise);\n\n  return disposable;\n};\n\nexport default createSubscriber;\n"],"names":["subscriptions","WeakMap","unobserveOrCancelIfNeeded","absintheSocket","notifier","observer","unobserveOrCancel","createDisposable","request","dispose","notifierFind","notifiers","onStart","deferred","resolve","onAbort","callback","error","reject","createSubscriber","onRecoverableError","variables","cacheConfig","operation","text","OnUnrecoverableError","onError","onNext","getOperationType","Error","send","createDeferred","onResult","observe","disposable","set","promise"],"mappings":";;;;;;;;;;;AAKA,IAAMA,aAGL,GAAG,IAAIC,OAAJ,EAHJ;;;;ACOA,IAAMC,yBAAyB,GAAG,mCAACC,cAAD,EAAiBC,QAAjB,EAA2BC,QAA3B,EAAwC;AAAA;;AACxE,MAAID,QAAJ,EAAc;AACZE,IAAAA,iBAAiB,CAACH,cAAD,EAAiBC,QAAjB,EAA2BC,QAA3B,CAAjB;AACD;AACF,CAJ8B,gBAA/B;;AAMA,IAAME,gBAAgB,GAAG,0BAACJ,cAAD,QAA4BE,QAA5B;AAAA;;AAAA,MAAkBG,OAAlB,QAAkBA,OAAlB;;AAAA;;AAAA,SAA0C;AACjEC,IAAAA,OAAO,EAAE;AAAA;;AAAA,aACPP,yBAAyB,CACvBC,cADuB,EAEvBO,YAAY,CAACP,cAAc,CAACQ,SAAhB,EAA2B,SAA3B,EAAsCH,OAAtC,CAFW,EAGvBH,QAHuB,CADlB;AAAA,KAAF;AAD0D,GAA1C;AAAA,CAAH,gBAAtB;;AASA,IAAMO,OAAO,GAAG,iBAAAC,QAAQ;AAAA;;AAAA;;AAAA,SAAI,UAAAT,QAAQ;AAAA;;AAAA,WAAIS,QAAQ,CAACC,OAAT,CAAiBV,QAAjB,CAAJ;AAAA,GAAZ;AAAA,CAAX,gBAAb;;AAEA,IAAMW,OAAO,GAAG,iBAACF,QAAD,EAAWG,QAAX;AAAA;;AAAA;;AAAA,SAAwB,UAAAC,KAAK,EAAI;AAAA;;AAC/C;AACA;AACAD,IAAAA,QAAQ,IAAIA,QAAQ,CAACC,KAAD,CAApB;AAEAJ,IAAAA,QAAQ,CAACK,MAAT,CAAgBD,KAAhB;AACD,GANe;AAAA,CAAH,gBAAb;AAQA;;;;;;IAIME,gBAAgB,GAAG,0BACvBhB,cADuB,EAEvBiB,kBAFuB;AAAA;;AAAA;;AAAA,SAGD,iBAEtBC,SAFsB,EAGtBC,WAHsB,SAKnB;AAAA,QAJIC,SAIJ,SAJFC,IAIE;AAAA,QADOC,oBACP,SADFC,OACE;AAAA,QAD6BC,MAC7B,SAD6BA,MAC7B;;AAAA;;AACH;AACA;AACA,QAAI,CAACJ,SAAD,IAAcK,gBAAgB,CAACL,SAAD,CAAhB,KAAgC,cAAlD,EAAkE;AAChE,YAAM,IAAIM,KAAJ,oDACyCN,SADzC,EAAN;AAGD;;AAED,QAAMnB,QAAQ,GAAG0B,IAAI,CAAC3B,cAAD,EAAiB;AAACoB,MAAAA,SAAS,EAATA,SAAD;AAAYF,MAAAA,SAAS,EAATA;AAAZ,KAAjB,CAArB;AAEA,QAAMR,QAAQ,GAAGkB,cAAc,EAA/B;AAEA,QAAM1B,QAAQ,GAAG;AACfU,MAAAA,OAAO,EAAEA,OAAO,CAACF,QAAD,EAAWY,oBAAX,CADD;AAEfC,MAAAA,OAAO,EAAEN,kBAFM;AAGfY,MAAAA,QAAQ,EAAGL,MAHI;AAIff,MAAAA,OAAO,EAAEA,OAAO,CAACC,QAAD;AAJD,KAAjB;AAOAoB,IAAAA,OAAO,CAAC9B,cAAD,EAAiBC,QAAjB,EAA2BC,QAA3B,CAAP;AAEA,QAAM6B,UAAU,GAAG3B,gBAAgB,CAACJ,cAAD,EAAiBC,QAAjB,EAA2BC,QAA3B,CAAnC;AAEAL,IAAAA,aAAa,CAACmC,GAAd,CAAkBD,UAAlB,EAA8BrB,QAAQ,CAACuB,OAAvC;AAEA,WAAOF,UAAP;AACD,GAnCwB;AAAA,CAAH;;;;"}